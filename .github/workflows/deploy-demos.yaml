name: Deploy demo sites

on:
  push:
    branches:
      - master

jobs:
  # pre-deploy:
  #   name: 🚧 Pre deploy
  #   runs-on: ubuntu-latest
  #   outputs:
  #     should_skip: ${{ steps.skip_check.outputs.should_skip }}
  #   steps:
  #     - id: skip_check
  #       name: 🛑 Make sure only a single deployment is running
  #       uses: fkirc/skip-duplicate-actions@master
  #       with:
  #         concurrent_skipping: always
  #         cancel_others: true
  #         # paths_ignore: '["**/*.md"]'

  deploy:
    # needs: pre-deploy
    # if: ${{ needs.pre-deploy.outputs.should_skip != 'true' }}
    name: 🚀 Deploy demo sites
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        config: [fnf, ofcra, 3cb, 242ns, rb]
        include:
          - config: fnf
            uname_secret: DB_USERNAME_FNF
            pword_secret: DB_PASSWORD_FNF
          - config: ofcra
            uname_secret: DB_USERNAME_OFCRA
            pword_secret: DB_PASSWORD_OFCRA
          - config: 3cb
            uname_secret: DB_USERNAME_3CB
            pword_secret: DB_PASSWORD_3CB
          - config: 242ns
            uname_secret: DB_USERNAME_242NS
            pword_secret: DB_PASSWORD_242NS
          - config: rb
            uname_secret: DB_USERNAME_RB
            pword_secret: DB_PASSWORD_RB

    steps:
      - name: 🚚 Get latest code
        uses: actions/checkout@v2

      - name: ✏️ Replace config[base_url]
        uses: jacobtomlinson/gha-find-replace@v2
        with:
          find: "$config['base_url'] = '';"
          replace: "$config['base_url'] = 'https://${{ matrix.config }}-stats.devs.space/';"
          include: "application/config/config.php"
          regex: false

      - name: ✏️ Replace autoload[config]
        uses: jacobtomlinson/gha-find-replace@v2
        with:
          find: "$autoload['config'] = array('localhost');"
          replace: "$autoload['config'] = array('${{ matrix.config }}');"
          include: "application/config/autoload.php"
          regex: false

      - name: ✏️ Replace db[default][username]
        uses: jacobtomlinson/gha-find-replace@v2
        with:
          find: "'username' => 'root',"
          replace: "'username' => '${{ secrets[matrix.uname_secret] }}',"
          include: "application/config/database.php"
          regex: false

      - name: ✏️ Replace db[default][password]
        uses: jacobtomlinson/gha-find-replace@v2
        with:
          find: "'password' => '',"
          replace: "'password' => '${{ secrets[matrix.pword_secret] }}',"
          include: "application/config/database.php"
          regex: false

      - name: ✏️ Replace db[default][database]
        uses: jacobtomlinson/gha-find-replace@v2
        with:
          find: "'database' => 'ocapstats',"
          replace: "'database' => '${{ secrets[matrix.uname_secret] }}',"
          include: "application/config/database.php"
          regex: false

      - name: 📂 Sync files
        uses: SamKirkland/FTP-Deploy-Action@4.1.0
        with:
          server: "${{ secrets.FTP_HOSTNAME }}"
          username: "${{ secrets.FTP_USERNAME }}"
          password: "${{ secrets.FTP_PASSWORD }}"
          server-dir: "${{ matrix.config }}-stats/"
          exclude: "[**/.git*, **/.git*/**, .sql/**, .dev/**, docker-compose.yml]"
          # dry-run: true
